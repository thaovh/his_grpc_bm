version: "3"

services:
  api-gateway:
    image: "api-gateway:dev"
    build:
      context: "./api-gateway"
    networks:
      - "frontend"
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: "test"
      PORT: "3000"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
      AUTH_SVC_URL: "auth-svc"
      AUTH_SVC_PORT: "50052"
      INTEGRATION_SVC_URL: "integration-svc"
      INTEGRATION_SVC_PORT: "50053"
    depends_on:
      - users-svc
      - auth-svc
      - integration-svc
    healthcheck:
      test: ["CMD", "wget", "localhost:3000/healthz -q -O - > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: "on-failure"

  users-svc:
    image: "users-svc:dev"
    build:
      context: "./microservices/users-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50051:50051"
    environment:
      NODE_ENV: "test"
      URL: "0.0.0.0"
      PORT: "50051"
      DB_HOST: "192.168.7.248"
      DB_PORT: "1521"
      DB_USER: "HXT_RS"
      DB_PASSWORD: "HXT_RS"
      DB_NAME: "orclstb"
      DB_SID: ""
      DB_SERVICE_NAME: "orclstb"
      DB_CONNECT_STRING: "192.168.7.248:1521/orclstb"
    # Removed depends_on: users-db vì giờ dùng database bên ngoài
    healthcheck:
      test: ["CMD", "wget", "localhost:50051 -q -O - > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: "on-failure"

  auth-svc:
    image: "auth-svc:dev"
    build:
      context: "./microservices/auth-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50052:50052"
    environment:
      NODE_ENV: "test"
      URL: "0.0.0.0"
      PORT: "50052"
      DB_HOST: "192.168.7.248"
      DB_PORT: "1521"
      DB_USER: "HXT_RS"
      DB_PASSWORD: "HXT_RS"
      DB_NAME: "orclstb"
      DB_SID: ""
      DB_SERVICE_NAME: "orclstb"
      DB_CONNECT_STRING: "192.168.7.248:1521/orclstb"
      DB_SYNCHRONIZE: "true"
      JWT_SECRET: "your-secret-key-change-in-production-min-32-chars"
      JWT_EXPIRES_IN: "15m"
      REFRESH_TOKEN_EXPIRES_IN: "7d"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
      INTEGRATION_SVC_URL: "integration-svc"
      INTEGRATION_SVC_PORT: "50053"
    depends_on:
      - users-svc
      - integration-svc
    healthcheck:
      test: ["CMD", "wget", "localhost:50052 -q -O - > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: "on-failure"

  integration-svc:
    image: "integration-svc:dev"
    build:
      context: "./microservices/integration-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50053:50053"
    environment:
      NODE_ENV: "test"
      URL: "0.0.0.0"
      PORT: "50053"
      EXTERNAL_AUTH_URL: "http://192.168.7.200:1401/api/Token/Login"
      HIS_VERSION: "2.377.0"
      HIS_MACHINE_NAME: "DESKTOP-HPQH46O"
      REDIS_HOST: "192.168.68.209"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "t123456"
      REDIS_DB: "0"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
    depends_on:
      - users-svc
      # Redis đã chạy external, không cần depends_on
    healthcheck:
      test: ["CMD", "wget", "localhost:50053 -q -O - > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: "on-failure"

  # Redis service đã được chạy external trên host 192.168.68.209:6379
  # Với password: t123456
  # docker run --name my-redis -p 6379:6379 -e REDIS_PASSWORD="t123456" -d redis:latest
  # Nếu cần chạy Redis trong Docker, uncomment service bên dưới
  # redis:
  #   image: "redis:7-alpine"
  #   networks:
  #     - "backend"
  #   ports:
  #     - "6379:6379"
  #   command: redis-server --requirepass t123456
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "-a", "t123456", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: "on-failure"

  # users-db service đã được comment vì giờ dùng Oracle database bên ngoài
  # Nếu cần dùng local database, uncomment service này
  # users-db:
  #   image: "gvenzl/oracle-xe:21-slim"
  #   networks:
  #     - "backend"
  #   ports:
  #     - "1521:1521"
  #   environment:
  #     ORACLE_PASSWORD: "t123456"
  #     ORACLE_DATABASE: "XEPDB1"
  #   volumes:
  #     - "users-db-data:/opt/oracle/oradata"
  #   healthcheck:
  #     test: ["CMD", "sqlplus", "-S", "SYSTEM/t123456@localhost:1521/XEPDB1", "@/dev/null"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #   restart: "on-failure"

  swagger-ui:
    image: "swaggerapi/swagger-ui:v3.25.0"
    networks:
      - "frontend"
    ports:
      - "8080:8080"
    volumes:
      - "./docs/openapi-spec.yaml:/usr/share/spec/openapi-spec.yaml"
    environment:
      SWAGGER_JSON: "/usr/share/spec/openapi-spec.yaml"
    healthcheck:
      test: ["CMD", "wget", "localhost:8080 -q -O - > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  frontend:
  backend:

# volumes:
#   users-db-data volume đã được comment vì không dùng local database nữa
