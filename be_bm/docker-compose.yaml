services:
  api-gateway:
    build:
      context: "./api-gateway"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "${GATEWAY_PORT:-3000}:3000"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      PORT: "3000"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
      AUTH_SVC_URL: "auth-svc"
      AUTH_SVC_PORT: "50052"
      INTEGRATION_SVC_URL: "integration-svc"
      INTEGRATION_SVC_PORT: "50053"
      INVENTORY_SVC_URL: "inventory-svc"
      INVENTORY_SVC_PORT: "50054"
      MASTER_DATA_SVC_URL: "master-data-svc"
      MASTER_DATA_SVC_PORT: "50055"
      MACHINE_SVC_URL: "machine-svc"
      MACHINE_SVC_PORT: "50056"
      ATTENDANCE_SVC_URL: "host.docker.internal"
      ATTENDANCE_SVC_PORT: "50057"
      GATEWAY_CONFIG_SVC_URL: "gateway-config-svc"
      GATEWAY_CONFIG_SVC_PORT: "50058"
      OTHER_EXP_MEST_TYPE_ID: "1,2,3,4,5"
      INPATIENT_EXP_MEST_TYPE_ID: "7"
      DEFAULT_EXPORT_STATUS_ID: "${DEFAULT_EXPORT_STATUS_ID:-2626d9a8-c95d-4710-9117-e8e9516e49fd}"
      DEFAULT_NOT_SYNC_EXPORT_STATUS_ID: "${DEFAULT_NOT_SYNC_EXPORT_STATUS_ID}"
      DEFAULT_ALL_EXPORTED_WORKING_STATE_ID: "${DEFAULT_ALL_EXPORTED_WORKING_STATE_ID}"
      S3_ENDPOINT: "${S3_ENDPOINT:-http://192.168.7.189:3900}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY}"
      S3_SECRET_KEY: "${S3_SECRET_KEY}"
      S3_REGION: "${S3_REGION:-garage}"
      S3_BUCKET: "${S3_BUCKET:-machine-info}"
      MEDIA_PUBLIC_URL: "${MEDIA_PUBLIC_URL}"
      REDIS_HOST: "redis"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    depends_on:
      - users-svc
      - auth-svc
      - integration-svc
      - inventory-svc
      - master-data-svc
      - machine-svc
      - attendance-svc
      - gateway-config-svc
      - redis
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: "on-failure"

  users-svc:
    build:
      context: "./microservices/users-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50051:50051"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50051"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
    restart: "on-failure"

  gateway-config-svc:
    build:
      context: "./microservices/gateway-config-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50058:50058"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50058"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
      KONG_ADMIN_URL: "${KONG_ADMIN_URL:-http://host.docker.internal:8001}"
      KONG_SERVICE_ID: "${KONG_SERVICE_ID}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: "on-failure"

  auth-svc:
    build:
      context: "./microservices/auth-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50052:50052"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50052"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
      JWT_SECRET: "${JWT_SECRET}"
      JWT_EXPIRES_IN: "${JWT_EXPIRES_IN:-120m}"
      REFRESH_TOKEN_EXPIRES_IN: "${REFRESH_TOKEN_EXPIRES_IN:-7d}"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
      INTEGRATION_SVC_URL: "integration-svc"
      INTEGRATION_SVC_PORT: "50053"
    depends_on:
      - users-svc
      - integration-svc
    restart: "on-failure"

  integration-svc:
    build:
      context: "./microservices/integration-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50053:50053"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50053"
      EXTERNAL_AUTH_URL: "${EXTERNAL_AUTH_URL}"
      EXTERNAL_DB_HOST: "${EXTERNAL_DB_HOST}"
      EXTERNAL_DB_PORT: "${EXTERNAL_DB_PORT}"
      EXTERNAL_DB_USER: "${EXTERNAL_DB_USER}"
      EXTERNAL_DB_PASSWORD: "${EXTERNAL_DB_PASSWORD}"
      EXTERNAL_DB_SERVICE_NAME: "${EXTERNAL_DB_SERVICE_NAME}"
      HIS_VERSION: "${HIS_VERSION:-2.377.0}"
      HIS_MACHINE_NAME: "${HIS_MACHINE_NAME:-DESKTOP-HPQH46O}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      REDIS_DB: "${REDIS_DB:-0}"
      USERS_SVC_URL: "users-svc"
      USERS_SVC_PORT: "50051"
      OTHER_EXP_MEST_TYPE_ID: "1,2,3,4,5"
      INPATIENT_EXP_MEST_TYPE_ID: "7"
      INPATIENT_ORDER_FIELD: "${INPATIENT_ORDER_FIELD:-MODIFY_TIME}"
      INPATIENT_ORDER_DIRECTION: "${INPATIENT_ORDER_DIRECTION:-DESC}"
      INPATIENT_IS_INCLUDE_DELETED: "${INPATIENT_IS_INCLUDE_DELETED:-false}"
      INPATIENT_DATA_DOMAIN_FILTER: "${INPATIENT_DATA_DOMAIN_FILTER:-false}"
    depends_on:
      - users-svc
      - redis
    restart: "on-failure"

  redis:
    image: "redis:7-alpine"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - "backend"
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: "on-failure"

  inventory-svc:
    build:
      context: "./microservices/inventory-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50054:50054"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50054"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
    restart: "on-failure"

  master-data-svc:
    build:
      context: "./microservices/master-data-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "50055:50055"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50055"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
    restart: "on-failure"

  machine-svc:
    build:
      context: "./microservices/machine-svc"
    networks:
      - "frontend"
      - "backend"
    ports:
      - "${MACHINE_SVC_PORT:-50056}:50056"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      PORT: "50056"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
    restart: "on-failure"

  attendance-svc:
    build:
      context: "./microservices/attendance-svc"
    network_mode: "host"
    volumes:
      - "./microservices/attendance-svc/config/firebase:/app/config/firebase"
    environment:
      NODE_ENV: "production"
      TZ: "Asia/Ho_Chi_Minh"
      URL: "0.0.0.0"
      GRPC_PORT: "50057"
      HTTP_PORT: "3006"
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      DB_SID: "${DB_SID}"
      DB_SERVICE_NAME: "${DB_SERVICE_NAME}"
      DB_CONNECT_STRING: "${DB_HOST}:${DB_PORT}/${DB_SERVICE_NAME}"
      REDIS_HOST: "127.0.0.1"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      WORKER_COUNT: "5"
      FIREBASE_PROJECT_ID: "bachmaistaff"
      FIREBASE_PRIVATE_KEY_PATH: "/app/config/firebase/service-account.json"
    depends_on:
      - redis
    restart: "on-failure"

  swagger-ui:
    image: "swaggerapi/swagger-ui:v3.25.0"
    networks:
      - "frontend"
    ports:
      - "8080:8080"
    volumes:
      - "./docs/openapi-spec.yaml:/usr/share/spec/openapi-spec.yaml"
    environment:
      SWAGGER_JSON: "/usr/share/spec/openapi-spec.yaml"

networks:
  frontend:
  backend:
